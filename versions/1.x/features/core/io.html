<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>I/O Enhancements | .NEXT </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="I/O Enhancements | .NEXT ">
    <meta name="generator" content="docfx 2.48.0.0">
    
    <link rel="shortcut icon" href="../../fav.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    
    
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../doc_logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="io-enhancements">I/O Enhancements</h1>

<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.io.binaryreader">BinaryReader</a> and <a href="https://docs.microsoft.com/en-us/dotnet/api/system.io.binarywriter">BinaryWriter</a> are aimed to high-level parsing or writing of stream content. These classes have several drawbacks:</p>
<ul>
<li>They don't provide asynchronous alternatives, especially for string</li>
<li>They should be allocated on the heap</li>
<li>They use internal buffer that is not accessible publicly</li>
</ul>
<p>The situation is worse when you need to have parse and write into the stream in the same time. In this case you need both <code>BinaryReader</code> and <code>BinaryWriter</code> with their own allocated buffers. So you have fourfold price: instance of writer and its internal buffer in the form of the array and instance of reader with its internal buffer. It is more complicated if your stream contains strings of different encodings.</p>
<p><a href="https://sakno.github.io/dotNext/api/DotNext.IO.StreamExtensions.html">StreamExtension</a> class contains extension methods for high-level parsing of stream content as well as typed writers with the following benefits:</p>
<ul>
<li>You can share the same buffer between reader and writer methods</li>
<li>You can manage how the buffer should be allocated: from <a href="https://docs.microsoft.com/en-us/dotnet/api/system.buffers.arraypool-1">array pool</a> or using <strong>new</strong> keyword</li>
<li>You can use different encodings to encode or decode strings in the same stream</li>
<li>Endianness of value types under your control</li>
</ul>
<p>The following example demonstrates how to use these methods:</p>
<pre><code class="lang-csharp">using DotNext.Buffers;
using DotNext.IO;
using System.Buffers.Binary;
using System.IO;

//read
using(var fs = new FileStream(&quot;content.bin&quot;, FileMode.Open, FileAccess.Read, FileShare.Read))
using(var buffer = new ArrayRental&lt;byte&gt;(1024)) //rent the buffer
{
    var lengthInBytes = BinaryPrimitives.ReadInt64LittleEndian(fs.ReadBytes(sizeof(long)));
    var str = await fs.ReadStringAsync(lengthInBytes, Encoding.UTF8);
}
</code></pre>
<h1 id="segmenting-streams">Segmenting streams</h1>
<p>In some cases you may need to hide the entire stream from the callee for the reading operation. This can be necessary to protect underlying stream from accidental seeking. <a href="https://sakno.github.io/dotNext/api/DotNext.IO.StreamSegment.html">StreamSegment</a> do the same for streams as <a href="https://docs.microsoft.com/en-us/dotnet/api/system.arraysegment-1">ArraySegment</a> for arrays.</p>
<div class="NOTE">
<h5>Note</h5>
<p>Stream segment is read-only stream that cannot be used for writes</p>
</div>
<p>The segment can be reused for multiple consumers because its position and length can be adjusted for the same instance.</p>
<pre><code class="lang-csharp">using DotNext.IO;
using System.IO;

using(var fs = new FileStream(&quot;content.bin&quot;, FileMode.Open, FileAccess.Read, FileShare.Read))
using(var segment = new StreamSegment(fs))
{
    foreach(Action&lt;Stream&gt; consumer in consumers)
    {
        segment.Adjust(10L, 1024L); //fs is limited to the segment limited by the offset of 10 from the beginning of the stream and length of 1024 bytes
        consumer(segment);
    }
}
</code></pre>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/sakno/DotNext/blob/gh-pages/docs/features/core/io.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
