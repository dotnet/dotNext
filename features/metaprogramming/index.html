<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Metaprogramming | .NEXT </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Metaprogramming | .NEXT ">
    <meta name="generator" content="docfx ">
  
    <link rel="shortcut icon" href="../../fav.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
  
  
  
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../doc_logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="metaprogramming">Metaprogramming</h1>

<p>Metaprogramming API provided by .NEXT library allows to generate and execute code in runtime. Code generation object model is language agnostic so developer can use it from any .NET programming language. From design point of view, metaprogramming capabilities built on top of <a href="https://docs.microsoft.com/en-us/dotnet/api/system.linq.expressions">LINQ Expressions</a> without direct usage of IL generator. This increases portability of the library between different .NET implementations. All custom expressions introduced by Metaprogramming libary are reducible into predefined set of LINQ Expressions.</p>
<div class="WARNING">
<h5>Warning</h5>
<p>Xamarin.iOS supports only interpretation of Expression Trees without Just-in-Time Compilation. Since the iPhone's kernel prevents an application from generating code dynamically Mono on the iPhone does not support any form of dynamic code generation. Check out <a href="https://docs.microsoft.com/en-us/xamarin/ios/internals/limitations">this article</a> for more information. As a result, the code generated using .NEXT Metaprogramming library demonstrates significantly slower performance on iOS.</p>
</div>
<p>Metaprogramming library extends LINQ Expression with the following features:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/tokens/interpolated">String Interpolation</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/using-statement">using statement</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/lock-statement">lock statement</a></li>
<li>Loops
<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/foreach-in">foreach loop</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/while">while loop</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/for">for loop</a></li>
</ul>
</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/visual-basic/language-reference/statements/with-end-with-statement">With..End statement</a></li>
<li>Full support of custom <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/async">async</a> lambda functions and <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/await">await</a> expressions</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-8.0/ranges">Ranges and Indicies</a></li>
<li>Pattern matching</li>
<li>Extension methods for easy construction of compound expressions and statements</li>
<li>Building expression trees using <strong>dynamic</strong> keyword in C#</li>
</ul>
<p>All these extensions are compatible with <a href="https://docs.microsoft.com/en-us/dotnet/api/system.linq.expressions.expression">Expression</a> class.</p>
<p>Additionally, .NEXT Metaprogramming library replaces limit of <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/expression-trees/">C# Expression Trees</a> where only single-line lambda expression is allowed.</p>
<div class="IMPORTANT">
<h5>Important</h5>
<p>Despite of rich set of Metaprogramming API, a few limits still exist. These restrictions dictated by internal design of LINQ Expression. The first, overloaded operators with <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/in-parameter-modifier">in parameter modifier</a> cannot be resolved. The second, <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/ref#reference-return-values">ref return</a> and <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/ref#ref-locals">ref locals</a> are not supported.</p>
</div>
<h1 id="concept">Concept</h1>
<p>The code construction based on the following concepts:</p>
<ul>
<li><a href="dynamic.html">Dynamic Construction of Expressions</a></li>
<li><a class="xref" href="../../api/DotNext.Metaprogramming.CodeGenerator.html">Code Generator</a> provides methods for adding statement such as method calls, assignment, loops, if-then-else statement etc.</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.ExpressionBuilder.html">Expression Builder</a> provides extension methods for constructing expressions</li>
</ul>
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.linq.expressions">Code expressions</a> from .NET library heavily extended with additional expression types:</p>
<ul>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.UsingExpression.html">using Expression</a> represents <code>using</code> statement from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.LockExpression.html">lock Expression</a> represents <code>lock</code> statement from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.AwaitExpression.html">await Expression</a> represents <code>await</code> operator from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.InterpolationExpression.html">String Interpolation Expression</a> represents interpolated string</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.ForEachExpression.html">for-in Expression</a> represents <code>foreach</code> loop from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.WhileExpression.html">while Expression</a> represents <code>while</code> and <code>do-while</code> loops from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.ForExpression.html">for Expression</a> represents <code>for</code> loop from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.CollectionAccessExpression.html">Element Access Expression</a> represents <a href="https://docs.microsoft.com/en-us/dotnet/api/system.index">index</a>-based access to individual elements of the collection or string</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.SliceExpression.html">Slice Expression</a> represents <a href="https://docs.microsoft.com/en-us/dotnet/api/system.range">range</a> of elements in arbitrary collection or string</li>
</ul>
<p>The lexical scope is enclosed by multi-line lambda function. The body of such function contains the code for generation of expressions and statements.</p>
<pre><code class="lang-csharp">using DotNext.Linq.Expressions;
using System;
using System.Linq.Expressions;
using static DotNext.Metaprogramming.CodeGenerator;

Func&lt;long, long&gt; fact = Lambda&lt;Func&lt;long, long&gt;&gt;(fun =&gt; 
{
    var arg = fun[0];    //declares access to lambda parameter
    //if-then-else expression
    If((Expression)(arg.AsDynamic() &gt; 1L))
        .Then(arg.AsDynamic() * fun.Invoke(arg.AsDynamic() - 1L))  //recursive invocation of the current lambda function
        .Else(arg)  //else branch
        .OfType&lt;long&gt;()
    .End();
    //declare local variable of type long
    var local = DeclareVariable&lt;long&gt;(&quot;local&quot;);
    //assignment
    Assign(local, -arg.AsDynamic());  //equivalent is the assignment statement local = -arg
    //try-catch
    Try(() =&gt; 
    {
        Return(10.Const());    //return from lambda function
    })
    .Finally(() =&gt; //finally block
    {  
        //method call Console.WriteLine(local);
        CallStatic(typeof(Console), nameof(Console.WriteLine), local);
    })
    .End(); //end of try block
}).Compile();
</code></pre>
<p>Statement construction methods from <code>CodeGenerator</code> mimic syntax of C# programming language that improves maintainability of the code.</p>

</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/dotnet/dotNext/blob/gh-pages/docs/features/metaprogramming/index.md/#L1" class="contribution-link">Edit this page</a>
                  </li>
                </ul>
              </div>
              <div class="toggle-mode">
                <div class="icon">
                  <i aria-hidden="true">☀</i>
                </div>
                <label class="switch">
                  <input type="checkbox" id="switch-style">
                  <span class="slider round"></span>
                </label>
                <div class="icon">
                  <i aria-hidden="true">☾</i>
                </div>
              </div>

              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <h5>In this article</h5>
              <div></div>
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <div class="pull-left">
        Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
        
            </div>
            <div class="toggle-mode pull-right visible-sm visible-xs">
              <div class="icon">
                <i aria-hidden="true">☀</i>
              </div>
              <label class="switch">
                <input type="checkbox" id="switch-style-m">
                <span class="slider round"></span>
              </label>
              <div class="icon">
                <i aria-hidden="true">☾</i>
              </div>
            </div>
          </div>
        </div>
        <script type="text/javascript" src="../../styles/toggle-theme.js"></script>
      </footer>    </div>

    <script type="text/javascript" src="../../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
